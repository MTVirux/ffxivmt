version: '3.3'

services:

  ffmt_backend:
    container_name: ${BACKEND_CONTAINER_NAME}
    build:
      context: .
      dockerfile: ${BACKEND_DOCKERFILE}
    image: ffmt_backend
    restart: "always"
    ports:
      - "${BACKEND_HOST_PORT}:80"
      - "${BACKEND_HOST_SSL_PORT}:443"
    environment:
      - APP_NAME=${APP_NAME}
      - PRIMARY_DOCKER_PORT=${PRIMARY_DOCKER_PORT}
      - SECONDARY_DOCKER_PORT=${SECONDARY_DOCKER_PORT}
      - PRIMARY_DOCKER_SSL_PORT=${PRIMARY_DOCKER_SSL_PORT}
      - SECONDARY_DOCKER_SSL_PORT=${SECONDARY_DOCKER_SSL_PORT}
    volumes:
      - ./backend:/var/www/html/
      - ${HOST_SSL_CERTS_DIR}:/etc/apache2/ssl
      - ${HOST_SSL_PRIVATE_KEY_DIR}:/etc/apache2/ssl/private
    networks:
      - ffmt_network
  
  ffmt_ws_worker:
    image: mtvirux/ubuntu-lunar-python3.10.5:latest
    container_name: ${WS_WORKER_CONTAINER_NAME}
    restart: "unless-stopped"
    depends_on:
      - ${SCYLLADB_CONTAINER_NAME}
      - ${BACKEND_CONTAINER_NAME}
    environment:
      - BACKEND_HOST=${BACKEND_CONTAINER_NAME}
      - SCYLLADB_HOST=${SCYLLADB_CONTAINER_NAME}
    volumes:
      - ./docker/ws_worker/startup_scripts:/startup_scripts
      - ./docker/ws_worker/server:/server
    networks:
      - ffmt_network

# DATABASES
  ffmt_scylla:
    container_name: ${SCYLLADB_CONTAINER_NAME}
    build: 
      context: .
      dockerfile: ${SCYLLADB_DOCKERFILE}
    image: ffmt_scylla
    restart: "unless-stopped"
    ports:
      - 9042:9042
      - 7000:7000
      - 7001:7001
      - 7199:7199
      - 9180:9180
      - 10000:10000
    volumes:
      - ./docker/scylla/persistent/data:/var/lib/scylla
      - ./docker/scylla/persistent/commitlog:/var/lib/scylla/commitlog
      - ./docker/scylla/persistent/saved_caches:/var/lib/scylla/saved_caches
      - ./docker/scylla/persistent/log:/var/log/scylla
      - ./docker/scylla/etc/scylla:/etc/scylla

    networks:
      - ffmt_network
      
networks:
  ffmt_network:
    driver: bridge