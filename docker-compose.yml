version: '3.3'

services:

  #FRONTEND

  ffmt_frontend:
    container_name: ${FRONTEND_CONTAINER_NAME}
    image: node:18-alpine3.16
    build:
      context: .
      dockerfile: ${FRONTEND_DOCKERFILE}
    restart: "always"
    ports:
      - "${FRONTEND_HOST_PORT}:80"
    
    volumes:
      - ./frontend:/var/www/html/
    networks:
      - ffmt_internal
      - ffmt_external

  


  # BACKEND

  ffmt_backend:
    container_name: ${BACKEND_CONTAINER_NAME}
    build:
      context: .
      dockerfile: ${BACKEND_DOCKERFILE}
    image: ffmt_backend
    restart: "always"
    ports:
      - "${BACKEND_HOST_PORT}:80"
      - "${BACKEND_HOST_SSL_PORT}:443"
    environment:
      - APP_NAME=${APP_NAME}
      - PRIMARY_DOCKER_PORT=${PRIMARY_DOCKER_PORT}
      - SECONDARY_DOCKER_PORT=${SECONDARY_DOCKER_PORT}
      - PRIMARY_DOCKER_SSL_PORT=${PRIMARY_DOCKER_SSL_PORT}
      - SECONDARY_DOCKER_SSL_PORT=${SECONDARY_DOCKER_SSL_PORT}
    volumes:
      - ./backend:/var/www/html/
    networks:
      - ffmt_internal
      - ffmt_external



# DATABASES

  ffmt_mariadb:
    image: ffmt_mariadb
    build:
      context: .
      dockerfile: ${MARIADB_DOCKERFILE}
    container_name: ${MARIADB_CONTAINER_NAME}
    restart: "always"
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE_NAME}
    volumes:
      - ./docker/mariadb:/etc/mysql/conf.d
      - ffmt_mariadb_data:/var/lib/mysql
    ports:
      - ${MARIADB_HOST_PORT}:3306
    networks:
      - ffmt_internal

  ffmt_redis:
    image: mtvirux/redis-stack-python3.10
    build: 
      context: .
      dockerfile: ${REDIS_DOCKERFILE}
    container_name: ${REDIS_CONTAINER_NAME}
    restart: "always"
    environment:

      - REDIS_CONFIG_FILE=${REDIS_CONFIG_FILE}
      - REDIS_DATA_DIR=${REDIS_DATA_DIR}

      - REDIS_SERVER_RESTART_DELAY=${REDIS_SERVER_RESTART_DELAY}
      - REDIS_MEMORY_CLEANER_RESTART_DELAY=${REDIS_MEMORY_CLEANER_RESTART_DELAY}

      - REDIS_MEMORY_CLEANER_INTERVAL=${REDIS_MEMORY_CLEANER_INTERVAL}
      - REDIS_MEMORY_CLEANER_TRIGGER_TYPE=${REDIS_MEMORY_CLEANER_TRIGGER_TYPE}

      - REDIS_MEMORY_CLEANER_THRESHOLD_PERCENTAGE=${REDIS_MEMORY_CLEANER_THRESHOLD_PERCENTAGE}
      - REDIS_MEMORY_CLEANER_THRESHOLD_SIZE=${REDIS_MEMORY_CLEANER_THRESHOLD_SIZE}

      - REDIS_SALES_DB=${REDIS_SALES_DB}
      - REDIS_LISTINGS_DB=${REDIS_LISTINGS_DB}
      - REDIS_RECENT_DB=${REDIS_RECENT_DB}
    ports:
      - "${REDIS_HOST_PORT}:6379"
      - "${REDISINSIGHT_HOST_PORT}:8001"
    volumes:
      - ./docker/redis/usr/local/etc/redis:/usr/local/etc/redis
      - ./docker/redis/usr/local/bin:/usr/local/bin
      - ./docker/redis/server:/server
    networks:
      - ffmt_internal
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT}

# DATABASE MANAGEMENT
  ffmt_pma:
    image: "phpmyadmin/phpmyadmin"
    container_name: ${PMA_CONTAINER_NAME}
    restart: "no"
    environment:
      - PMA_HOST=${MARIADB_CONTAINER_NAME}
    ports:
      - ${PMA_HOST_PORT}:80
    depends_on:
      - ${MARIADB_CONTAINER_NAME}
    networks:
      - ffmt_internal
      - ffmt_external

  #ffmt_redisinsight:
  #  image: "redislabs/redisinsight:latest"
  #  container_name: ${REDISINSIGHT_CONTAINER_NAME}
  #  restart: "no"
  #  environment:
  #    - RIPORT=${REDISINSIGHT_HOST_PORT}
  #    - RIHOST=${RIHOST}
  #    - RILOGDIR=${RILOGDIR}
  #  ports:
  #    - ${REDISINSIGHT_HOST_PORT}:8001
  #  depends_on:
  #    - ${REDIS_CONTAINER_NAME}
  #  volumes:
  #    - ffmt_redisinsight_data:/db
  #  networks:
  #    - ffmt_internal
  #    - ffmt_external

#VOLUMES
volumes:

  ffmt_mariadb_data:
    external: true

  ffmt_redis_data:
    external: true
  
  ffmt_redisinsight_data:
    external: true


#NETWORKS
networks:
  
  ffmt_internal:
    driver: bridge
    external: false
  
  ffmt_external:
    driver: bridge
    external: false


