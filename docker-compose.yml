version: '3.3'

services:

  #FRONTEND

  #ffmt_react:
  #  container_name: ffmt_react
  #  image: node:18-alpine3.16
  #  build:
  #    context: .
  #    dockerfile: ${FRONTEND_DOCKERFILE}
  #  restart: "always"
  #  ports:
  #    - "${FRONTEND_HOST_PORT}:8082"
  #  
  #  volumes:
  #    - ./docker/react_app:/var/www/html/
  #  networks:
  #    - ffmt_internal
  #    - ffmt_external

  #ffmt_vue:
  #  container_name: ffmt_vue
  #  image: node:18-alpine3.16
  #  build:
  #    context: .
  #    dockerfile: ${FRONTEND_DOCKERFILE}
  #  restart: "always"
  #  ports:
  #    - "${FRONTEND_HOST_PORT}:8080"
  #  
  #  volumes:
  #    - ./docker/vue_app:/vue_app
  #  networks:
  #    - ffmt_internal
  #    - ffmt_external
  


  # BACKEND

  ffmt_backend:
    container_name: ${BACKEND_CONTAINER_NAME}
    build:
      context: .
      dockerfile: ${BACKEND_DOCKERFILE}
    image: ffmt_backend
    restart: "always"
    ports:
      - "${BACKEND_HOST_PORT}:80"
      - "${BACKEND_HOST_SSL_PORT}:443"
    environment:
      - APP_NAME=${APP_NAME}
      - PRIMARY_DOCKER_PORT=${PRIMARY_DOCKER_PORT}
      - SECONDARY_DOCKER_PORT=${SECONDARY_DOCKER_PORT}
      - PRIMARY_DOCKER_SSL_PORT=${PRIMARY_DOCKER_SSL_PORT}
      - SECONDARY_DOCKER_SSL_PORT=${SECONDARY_DOCKER_SSL_PORT}
    volumes:
      - ./backend:/var/www/html/
    networks:
      - ffmt_internal
      - ffmt_external



# DATABASES

  ffmt_mariadb:
    image: ffmt_mariadb
    build:
      context: .
      dockerfile: ${MARIADB_DOCKERFILE}
    container_name: ${MARIADB_CONTAINER_NAME}
    restart: "always"
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE_NAME}
    volumes:
      - ./docker/mariadb:/etc/mysql/conf.d
      - ffmt_mariadb_data:/var/lib/mysql
    ports:
      - ${MARIADB_HOST_PORT}:3306
    networks:
      - ffmt_internal

  ffmt_redis:
    image: mtvirux/redis-stack-python:R702rc3-p3.10.5
    build: 
      context: .
      dockerfile: ${REDIS_DOCKERFILE}
    container_name: ${REDIS_CONTAINER_NAME}
    restart: "always"
    environment:

      - REDIS_CONFIG_FILE=${REDIS_CONFIG_FILE}
      - REDIS_DATA_DIR=${REDIS_DATA_DIR}
      - REDIS_SERVER_LOGS_DIR=${REDIS_SERVER_LOGS_DIR}

      - REDIS_SERVER_RESTART_DELAY=${REDIS_SERVER_RESTART_DELAY}
      - REDIS_MEMORY_CLEANER_RESTART_DELAY=${REDIS_MEMORY_CLEANER_RESTART_DELAY}

      - REDIS_MEMORY_CLEANER_INTERVAL=${REDIS_MEMORY_CLEANER_INTERVAL}
      - REDIS_MEMORY_CLEANER_TRIGGER_TYPE=${REDIS_MEMORY_CLEANER_TRIGGER_TYPE}

      - REDIS_MEMORY_CLEANER_THRESHOLD_PERCENTAGE=${REDIS_MEMORY_CLEANER_THRESHOLD_PERCENTAGE}
      - REDIS_MEMORY_CLEANER_THRESHOLD_SIZE=${REDIS_MEMORY_CLEANER_THRESHOLD_SIZE}

      - REDIS_INDEX_DB=${REDIS_INDEX_DB}
      - REDIS_SALES_DB=${REDIS_SALES_DB}
      - REDIS_TIMESERIES_DB=${REDIS_TIMESERIES_DB}
      - REDIS_LISTINGS_DB=${REDIS_LISTINGS_DB}

      - REDIS_STATUS_UPDATER_INTERVAL=${REDIS_STATUS_UPDATER_INTERVAL}

      - REDIS_CPU_LOG_FILE=${REDIS_CPU_LOG_FILE}
      - REDIS_STATS_LOG_FILE=${REDIS_STATS_LOG_FILE}

      - BACKEND_HOST=${BACKEND_CONTAINER_NAME}

      - REDISTIMESERIES_ARGS=${REDISTIMESERIES_ARGS}

    ports:
      - "${REDIS_HOST_PORT}:6379"
      - "${REDISINSIGHT_HOST_PORT}:8001"
      
    volumes:
      - ./docker/redis/usr/local/etc/redis:/usr/local/etc/redis
      - ./docker/redis/usr/local/bin:/usr/local/bin
      - ./docker/redis/server:/server
      - ./docker/redis/monitor_server.sh:/monitor_server.sh
      #- ./docker/redis/server/redis-config/redis-stack.conf:/redis-stack.conf
      - ./docker/redis/server/redis-config/redis-custom-stack.conf:/redis-stack.conf
      - ./docker/redis/data/:/data
    networks:
      - ffmt_internal
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEMORY_LIMIT}

# DATABASE MANAGEMENT
  ffmt_pma:
    image: "phpmyadmin/phpmyadmin"
    container_name: ${PMA_CONTAINER_NAME}
    restart: "no"
    environment:
      - PMA_HOST=${MARIADB_CONTAINER_NAME}
      - UPLOAD_LIMIT=300M
    ports:
      - ${PMA_HOST_PORT}:80
    depends_on:
      - ${MARIADB_CONTAINER_NAME}
    networks:
      - ffmt_internal
      - ffmt_external

  #SYSTEM MANAGEMENT
  ffmt_portainer:
    image: portainer/portainer-ce
    container_name: ${PORTAINER_CONTAINER_NAME}
    restart: "no"
    ports:
      - ${PORTAINER_HOST_PORT}:9000
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./docker/portainer/data:/data
    networks:
      - ffmt_internal
      - ffmt_external


  #ffmt_redisinsight:
  #  image: "redislabs/redisinsight:latest"
  #  container_name: ${REDISINSIGHT_CONTAINER_NAME}
  #  restart: "no"
  #  environment:
  #    - RIPORT=${REDISINSIGHT_HOST_PORT}
  #    - RIHOST=${RIHOST}
  #    - RILOGDIR=${RILOGDIR}
  #  ports:
  #    - ${REDISINSIGHT_HOST_PORT}:8001
  #  depends_on:
  #    - ${REDIS_CONTAINER_NAME}
  #  volumes:
  #    - ffmt_redisinsight_data:/db
  #  networks:
  #    - ffmt_internal
  #    - ffmt_external

#VOLUMES
volumes:

  ffmt_mariadb_data:
    external: true

  #ffmt_redis_data:
  #  external: true


#NETWORKS
networks:
  
  ffmt_internal:
    driver: bridge
    external: false
  
  ffmt_external:
    driver: bridge
    external: false


